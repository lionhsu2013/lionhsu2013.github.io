<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÅ•Â∫∑Êï∏ÊìöË®òÈåÑ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 25px;
        }
        
        button {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            grid-column: 1 / -1;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .record {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .record-date {
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }
        
        .record-delete {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .record-data {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 14px;
        }
        
        .data-item {
            text-align: center;
        }
        
        .data-label {
            color: #666;
            font-size: 12px;
        }
        
        .data-value {
            font-weight: 700;
            color: #333;
            font-size: 16px;
            margin-top: 3px;
        }
        
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 14px;
        }
        
        .status-message {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .google-setup {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #856404;
        }
        
        .google-setup strong {
            display: block;
            margin-bottom: 5px;
        }
        
        .analysis-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }
        
        .analysis-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .analysis-card p {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .health-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .status-good {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-bottom: 20px;
        }
        
        .reminder-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reminder-info {
            flex: 1;
        }
        
        .reminder-time {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .reminder-label {
            color: #666;
            font-size: 14px;
        }
        
        .reminder-toggle {
            width: 50px;
            height: 26px;
            background: #ccc;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .reminder-toggle.active {
            background: #667eea;
        }
        
        .reminder-toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }
        
        .reminder-toggle.active::after {
            left: 26px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .stat-unit {
            font-size: 14px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üè• ÂÅ•Â∫∑Êï∏ÊìöË®òÈåÑ</h1>
            <p class="subtitle">Ë°ÄÂ£ì ‚Ä¢ ÂøÉË∑≥ ‚Ä¢ È´îÈáç</p>
            
            <div class="tabs">
                <button class="tab active" data-tab="record">üìù Ë®òÈåÑ</button>
                <button class="tab" data-tab="chart">üìä ÂúñË°®</button>
                <button class="tab" data-tab="analysis">üîç ÂàÜÊûê</button>
                <button class="tab" data-tab="reminder">‚è∞ ÊèêÈÜí</button>
            </div>
            
            <!-- Ë®òÈåÑÊ®ôÁ±§È†Å -->
            <div id="recordTab" class="tab-content active">
                <div class="google-setup">
                    <strong>‚ö†Ô∏è Google Sheets Ë®≠ÂÆöË™™ÊòéÔºö</strong>
                    Ë≥áÊñôÊúÉËá™ÂãïÂÑ≤Â≠òÂú®Êú¨Ê©üÔºå‰∏¶Âú®Ë®≠ÂÆöÂæåËá™ÂãïÂêåÊ≠•Âà∞ Google Sheets
                </div>
                
                <div id="statusMessage"></div>
                
                <div class="input-group">
                    <label>Êî∂Á∏ÆÂ£ì (mmHg)</label>
                    <input type="number" id="systolic" placeholder="‰æãÂ¶ÇÔºö120">
                </div>
                
                <div class="input-group">
                    <label>ËàíÂºµÂ£ì (mmHg)</label>
                    <input type="number" id="diastolic" placeholder="‰æãÂ¶ÇÔºö80">
                </div>
                
                <div class="input-group">
                    <label>ÂøÉË∑≥ (Ê¨°/ÂàÜ)</label>
                    <input type="number" id="heartRate" placeholder="‰æãÂ¶ÇÔºö72">
                </div>
                
                <div class="input-group">
                    <label>È´îÈáç (kg)</label>
                    <input type="number" step="0.1" id="weight" placeholder="‰æãÂ¶ÇÔºö65.5">
                </div>
                
                <div class="btn-group">
                    <button class="btn-primary" id="addRecordBtn">üìù Ë®òÈåÑÊï∏Êìö</button>
                    <button class="btn-secondary" id="syncBtn">‚òÅÔ∏è ÂêåÊ≠•</button>
                    <button class="btn-secondary" id="exportBtn">üì§ ÂåØÂá∫</button>
                </div>
            </div>
            
            <!-- ÂúñË°®Ê®ôÁ±§È†Å -->
            <div id="chartTab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Âπ≥ÂùáË°ÄÂ£ì</div>
                        <div class="stat-value" id="avgBP">--</div>
                        <div class="stat-unit">mmHg</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Âπ≥ÂùáÂøÉË∑≥</div>
                        <div class="stat-value" id="avgHR">--</div>
                        <div class="stat-unit">Ê¨°/ÂàÜ</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Áï∂ÂâçÈ´îÈáç</div>
                        <div class="stat-value" id="currentWeight">--</div>
                        <div class="stat-unit">kg</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">È´îÈáçËÆäÂåñ</div>
                        <div class="stat-value" id="weightChange">--</div>
                        <div class="stat-unit">kg</div>
                    </div>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">Ë°ÄÂ£ìË∂®Âã¢</h3>
                <div class="chart-container">
                    <canvas id="bpChart"></canvas>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">ÂøÉË∑≥Ë∂®Âã¢</h3>
                <div class="chart-container">
                    <canvas id="hrChart"></canvas>
                </div>
                
                <h3 style="color: #667eea; margin-bottom: 15px;">È´îÈáçË∂®Âã¢</h3>
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
            
            <!-- ÂàÜÊûêÊ®ôÁ±§È†Å -->
            <div id="analysisTab" class="tab-content">
                <div id="healthStatus"></div>
                <div id="analysisContent"></div>
            </div>
            
            <!-- ÊèêÈÜíÊ®ôÁ±§È†Å -->
            <div id="reminderTab" class="tab-content">
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                    Ë®≠ÂÆöÊØèÊó•ÊèêÈÜíÊôÇÈñìÔºåËÆìÊàëÂÄëÂçîÂä©ÊÇ®È§äÊàêÈáèÊ∏¨ÁøíÊÖ£
                </p>
                
                <div class="input-group">
                    <label>‚è∞ Êó©‰∏äÊèêÈÜíÊôÇÈñì</label>
                    <input type="time" id="morningTime" value="08:00">
                </div>
                
                <div class="reminder-item">
                    <div class="reminder-info">
                        <div class="reminder-time" id="morningTimeDisplay">08:00</div>
                        <div class="reminder-label">Êó©‰∏äÈáèÊ∏¨ÊèêÈÜí</div>
                    </div>
                    <div class="reminder-toggle" id="morningToggle" data-type="morning"></div>
                </div>
                
                <div class="input-group">
                    <label>‚è∞ Êôö‰∏äÊèêÈÜíÊôÇÈñì</label>
                    <input type="time" id="eveningTime" value="20:00">
                </div>
                
                <div class="reminder-item">
                    <div class="reminder-info">
                        <div class="reminder-time" id="eveningTimeDisplay">20:00</div>
                        <div class="reminder-label">Êôö‰∏äÈáèÊ∏¨ÊèêÈÜí</div>
                    </div>
                    <div class="reminder-toggle" id="eveningToggle" data-type="evening"></div>
                </div>
                
                <button class="btn-primary" id="saveRemindersBtn">üíæ ÂÑ≤Â≠òÊèêÈÜíË®≠ÂÆö</button>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px; font-size: 13px; color: #1565c0;">
                    <strong>üì± ÊèêÈÜíÂäüËÉΩË™™ÊòéÔºö</strong><br>
                    Áî±ÊñºÁÄèË¶ΩÂô®ÈôêÂà∂ÔºåÊèêÈÜíÂäüËÉΩÈúÄË¶ÅÊÇ®ÂÖÅË®±ÈÄöÁü•Ê¨äÈôê„ÄÇÈªûÊìäÂÑ≤Â≠òÂæåÔºåÁ≥ªÁµ±ÊúÉË´ãÊ±ÇÊ¨äÈôê„ÄÇË´ãÁ¢∫‰øùÊâãÊ©üË®≠ÂÆö‰∏≠‰πüÂÖÅË®±ÁÄèË¶ΩÂô®ÁöÑÈÄöÁü•„ÄÇ
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìä Ê≠∑Âè≤Ë®òÈåÑ</h2>
            <div id="recordsList"></div>
        </div>
    </div>

    <script>
        let healthRecords = [];
        let bpChart, hrChart, weightChart;
        let reminders = {
            morning: { enabled: false, time: '08:00' },
            evening: { enabled: false, time: '20:00' }
        };
        let reminderIntervals = [];
        
        // Ë´ãÂú®Ê≠§Â°´ÂÖ•‰Ω†ÁöÑ Google Apps Script Web App URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzYWAw6lOkgStc_LdlX5wEFk5rw03Qp_jOjQK62wkfowTa8uqI2467G6ZFN9PL1F9Rl/exec';
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromLocalStorage();
            initTabs();
            initButtons();
            renderRecords();
            loadRemindersFromLocalStorage();
        });
        
        // Âæû localStorage ËºâÂÖ•Ë≥áÊñô
        function loadDataFromLocalStorage() {
            try {
                const savedRecords = localStorage.getItem('healthRecords');
                if (savedRecords) {
                    healthRecords = JSON.parse(savedRecords);
                }
            } catch (error) {
                console.error('ËºâÂÖ•Ë≥áÊñôÂ§±Êïó:', error);
                healthRecords = [];
            }
        }
        
        // ÂÑ≤Â≠òË≥áÊñôÂà∞ localStorage
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('healthRecords', JSON.stringify(healthRecords));
            } catch (error) {
                console.error('ÂÑ≤Â≠òË≥áÊñôÂ§±Êïó:', error);
                showStatus('‚ùå Ë≥áÊñôÂÑ≤Â≠òÂ§±Êïó', true);
            }
        }
        
        // ËºâÂÖ•ÊèêÈÜíË®≠ÂÆö
        function loadRemindersFromLocalStorage() {
            try {
                const savedReminders = localStorage.getItem('reminders');
                if (savedReminders) {
                    reminders = JSON.parse(savedReminders);
                }
            } catch (error) {
                console.error('ËºâÂÖ•ÊèêÈÜíË®≠ÂÆöÂ§±Êïó:', error);
            }
            
            document.getElementById('morningTime').value = reminders.morning.time;
            document.getElementById('eveningTime').value = reminders.evening.time;
            updateTimeDisplay();
            
            if (reminders.morning.enabled) {
                document.getElementById('morningToggle').classList.add('active');
                setupReminderNotifications();
            }
            if (reminders.evening.enabled) {
                document.getElementById('eveningToggle').classList.add('active');
                setupReminderNotifications();
            }
        }
        
        // ÂÑ≤Â≠òÊèêÈÜíË®≠ÂÆö
        function saveRemindersToLocalStorage() {
            try {
                localStorage.setItem('reminders', JSON.stringify(reminders));
            } catch (error) {
                console.error('ÂÑ≤Â≠òÊèêÈÜíË®≠ÂÆöÂ§±Êïó:', error);
            }
        }
        
        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }
        
        function initButtons() {
            document.getElementById('addRecordBtn').addEventListener('click', addRecord);
            document.getElementById('syncBtn').addEventListener('click', syncToGoogle);
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('saveRemindersBtn').addEventListener('click', saveReminders);
            
            document.querySelectorAll('.reminder-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    toggleReminder(type);
                });
            });
            
            document.getElementById('morningTime').addEventListener('change', updateTimeDisplay);
            document.getElementById('eveningTime').addEventListener('change', updateTimeDisplay);
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'chart') {
                updateCharts();
            } else if (tabName === 'analysis') {
                updateAnalysis();
            }
        }
        
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = isError ? 'status-message status-error' : 'status-message status-success';
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        function addRecord() {
            const systolic = document.getElementById('systolic').value;
            const diastolic = document.getElementById('diastolic').value;
            const heartRate = document.getElementById('heartRate').value;
            const weight = document.getElementById('weight').value;
            
            if (!systolic || !diastolic || !heartRate || !weight) {
                showStatus('Ë´ãÂ°´ÂØ´ÊâÄÊúâÊ¨Ñ‰Ωç', true);
                return;
            }
            
            const record = {
                id: Date.now(),
                date: new Date().toLocaleString('zh-TW'),
                timestamp: Date.now(),
                systolic: parseInt(systolic),
                diastolic: parseInt(diastolic),
                heartRate: parseInt(heartRate),
                weight: parseFloat(weight)
            };
            
            healthRecords.unshift(record);
            
            // ÂÑ≤Â≠òÂà∞ localStorage
            saveDataToLocalStorage();
            
            document.getElementById('systolic').value = '';
            document.getElementById('diastolic').value = '';
            document.getElementById('heartRate').value = '';
            document.getElementById('weight').value = '';
            
            renderRecords();
            showStatus('‚úÖ Ë®òÈåÑÂ∑≤Êñ∞Â¢û');
            
            // Ëá™ÂãïÂêåÊ≠•Âà∞ Google Sheets
            if (GOOGLE_SCRIPT_URL) {
                syncToGoogle();
            } else {
                showStatus('‚ö†Ô∏è Êú™Ë®≠ÂÆö Google SheetsÔºåË≥áÊñôÂÉÖÂÑ≤Â≠òÂú®Êú¨Ê©ü', false);
            }
        }
        
        function deleteRecord(id) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®òÈåÑÂóéÔºü')) {
                healthRecords = healthRecords.filter(r => r.id !== id);
                
                // Êõ¥Êñ∞ localStorage
                saveDataToLocalStorage();
                
                renderRecords();
                showStatus('üóëÔ∏è Ë®òÈåÑÂ∑≤Âà™Èô§');
                
                // ÂêåÊ≠•Âà∞ Google Sheets
                if (GOOGLE_SCRIPT_URL) {
                    syncToGoogle();
                }
            }
        }
        
        function renderRecords() {
            const container = document.getElementById('recordsList');
            
            if (healthRecords.length === 0) {
                container.innerHTML = '<div class="empty-state">üì≠ Â∞öÁÑ°Ë®òÈåÑ<br>ÈñãÂßãË®òÈåÑ‰Ω†ÁöÑÂÅ•Â∫∑Êï∏ÊìöÂêßÔºÅ</div>';
                return;
            }
            
            container.innerHTML = healthRecords.map(record => `
                <div class="record">
                    <div class="record-header">
                        <span class="record-date">${record.date}</span>
                        <button class="record-delete" onclick="deleteRecord(${record.id})">Âà™Èô§</button>
                    </div>
                    <div class="record-data">
                        <div class="data-item">
                            <div class="data-label">Ë°ÄÂ£ì</div>
                            <div class="data-value">${record.systolic}/${record.diastolic}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">ÂøÉË∑≥</div>
                            <div class="data-value">${record.heartRate}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">È´îÈáç</div>
                            <div class="data-value">${record.weight}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function syncToGoogle() {
            if (!GOOGLE_SCRIPT_URL) {
                showStatus('‚ùå Ë´ãÂÖàÂú®Á®ãÂºèÁ¢º‰∏≠Ë®≠ÂÆö Google Sheets URL', true);
                return;
            }
            
            try {
                showStatus('‚è≥ ÂêåÊ≠•‰∏≠...');
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        records: healthRecords
                    }),
                    redirect: 'follow'
                });
                
                const result = await response.text();
                console.log('ÂêåÊ≠•ÂõûÊáâ:', result);
                
                try {
                    const jsonResult = JSON.parse(result);
                    if (jsonResult.status === 'success') {
                        showStatus('‚òÅÔ∏è Â∑≤ÂêåÊ≠•Âà∞ Google Sheets (' + (jsonResult.count || healthRecords.length) + ' Á≠Ü)');
                    } else {
                        showStatus('‚ö†Ô∏è ' + jsonResult.message, true);
                    }
                } catch (e) {
                    // Â¶ÇÊûúÂõûÊáâ‰∏çÊòØ JSONÔºå‰ΩÜÊ≤íÊúâÈåØË™§ÔºåË¶ñÁÇ∫ÊàêÂäü
                    showStatus('‚òÅÔ∏è Â∑≤ÂêåÊ≠•Âà∞ Google Sheets');
                }
                
            } catch (error) {
                console.error('ÂêåÊ≠•ÈåØË™§:', error);
                showStatus('‚ùå ÂêåÊ≠•Â§±Êïó: ' + error.message, true);
            }
        }
        
        function exportData() {
            if (healthRecords.length === 0) {
                showStatus('‚ùå Ê≤íÊúâË≥áÊñôÂèØ‰ª•ÂåØÂá∫', true);
                return;
            }
            
            const csv = [
                ['Êó•Êúü', 'Êî∂Á∏ÆÂ£ì', 'ËàíÂºµÂ£ì', 'ÂøÉË∑≥', 'È´îÈáç'],
                ...healthRecords.map(r => [r.date, r.systolic, r.diastolic, r.heartRate, r.weight])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ÂÅ•Â∫∑Ë®òÈåÑ_${new Date().toLocaleDateString('zh-TW')}.csv`;
            link.click();
            
            showStatus('üì§ Ë≥áÊñôÂ∑≤ÂåØÂá∫');
        }
        
        function updateCharts() {
            if (healthRecords.length === 0) {
                document.getElementById('avgBP').textContent = '--';
                document.getElementById('avgHR').textContent = '--';
                document.getElementById('currentWeight').textContent = '--';
                document.getElementById('weightChange').textContent = '--';
                return;
            }
            
            const recentRecords = healthRecords.slice(0, 10).reverse();
            const labels = recentRecords.map(r => {
                const date = new Date(r.timestamp);
                return `${date.getMonth()+1}/${date.getDate()}`;
            });
            
            // Êõ¥Êñ∞Áµ±Ë®àÊï∏Êìö
            const avgSystolic = Math.round(recentRecords.reduce((sum, r) => sum + r.systolic, 0) / recentRecords.length);
            const avgDiastolic = Math.round(recentRecords.reduce((sum, r) => sum + r.diastolic, 0) / recentRecords.length);
            const avgHR = Math.round(recentRecords.reduce((sum, r) => sum + r.heartRate, 0) / recentRecords.length);
            const currentW = recentRecords[recentRecords.length - 1].weight;
            const firstW = recentRecords[0].weight;
            const weightDiff = (currentW - firstW).toFixed(1);
            
            document.getElementById('avgBP').textContent = `${avgSystolic}/${avgDiastolic}`;
            document.getElementById('avgHR').textContent = avgHR;
            document.getElementById('currentWeight').textContent = currentW;
            document.getElementById('weightChange').textContent = weightDiff > 0 ? `+${weightDiff}` : weightDiff;
            
            // Ë°ÄÂ£ìÂúñË°®
            if (bpChart) bpChart.destroy();
            const bpCtx = document.getElementById('bpChart').getContext('2d');
            bpChart = new Chart(bpCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Êî∂Á∏ÆÂ£ì',
                        data: recentRecords.map(r => r.systolic),
                        borderColor: '#f5576c',
                        backgroundColor: 'rgba(245, 87, 108, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'ËàíÂºµÂ£ì',
                        data: recentRecords.map(r => r.diastolic),
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
            
            // ÂøÉË∑≥ÂúñË°®
            if (hrChart) hrChart.destroy();
            const hrCtx = document.getElementById('hrChart').getContext('2d');
            hrChart = new Chart(hrCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ÂøÉË∑≥',
                        data: recentRecords.map(r => r.heartRate),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
            
            // È´îÈáçÂúñË°®
            if (weightChart) weightChart.destroy();
            const weightCtx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'È´îÈáç',
                        data: recentRecords.map(r => r.weight),
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }
        
        function updateAnalysis() {
            if (healthRecords.length === 0) {
                document.getElementById('analysisContent').innerHTML = '<div class="empty-state">üì≠ Â∞öÁÑ°Êï∏ÊìöÂèØ‰æõÂàÜÊûê<br>Ë´ãÂÖàË®òÈåÑÊÇ®ÁöÑÂÅ•Â∫∑Êï∏Êìö</div>';
                document.getElementById('healthStatus').innerHTML = '';
                return;
            }
            
            const latest = healthRecords[0];
            let statusHTML = '';
            let analysisHTML = '';
            
            // Ë°ÄÂ£ìÂàÜÊûê
            if (latest.systolic >= 140 || latest.diastolic >= 90) {
                statusHTML += '<div class="health-status status-danger">‚ö†Ô∏è Ë°ÄÂ£ìÂÅèÈ´òÔºåÂª∫Ë≠∞Ë´ÆË©¢ÈÜ´Â∏´</div>';
                analysisHTML += `
                    <div class="analysis-card">
                        <h3>ü©∫ Ë°ÄÂ£ìÂàÜÊûê</h3>
                        <p>ÊÇ®ÁöÑÊúÄÊñ∞Ë°ÄÂ£ìÁÇ∫ ${latest.systolic}/${latest.diastolic} mmHgÔºåÊï∏ÂÄºÂÅèÈ´ò„ÄÇÈ´òË°ÄÂ£ìÂèØËÉΩÂ¢ûÂä†ÂøÉË°ÄÁÆ°ÁñæÁóÖÈ¢®Èö™„ÄÇÂª∫Ë≠∞ÔºöÊ∏õÂ∞ëÈπΩÂàÜÊîùÂèñ„ÄÅË¶èÂæãÈÅãÂãï„ÄÅ‰øùÊåÅÊ≠£Â∏∏È´îÈáçÔºå‰∏¶ÂÆöÊúüËøΩËπ§Ë°ÄÂ£ìËÆäÂåñ„ÄÇÂ¶ÇÊåÅÁ∫åÂÅèÈ´òÔºåË´ãÂèäÊôÇÂ∞±ÈÜ´„ÄÇ</p>
                    </div>
                `;
            } else if (latest.systolic >= 120 || latest.diastolic >= 80) {
                statusHTML += '<div class="health-status status-warning">‚ö° Ë°ÄÂ£ìÁ®çÈ´òÔºåË´ãÊåÅÁ∫åÁõ£Ê∏¨</div>';
                analysisHTML += `
                    <div class="analysis-card">
                        <h3>ü©∫ Ë°ÄÂ£ìÂàÜÊûê</h3>
                        <p>ÊÇ®ÁöÑÊúÄÊñ∞Ë°ÄÂ£ìÁÇ∫ ${latest.systolic}/${latest.diastolic} mmHgÔºåÂ±¨ÊñºË°ÄÂ£ìÂâçÊúü„ÄÇÂª∫Ë≠∞Ë™øÊï¥ÁîüÊ¥ªÊñπÂºèÔºöÁ∂≠ÊåÅÂÅ•Â∫∑È£≤È£ü„ÄÅË¶èÂæãÈÅãÂãï„ÄÅÊ∏õËºïÂ£ìÂäõÔºå‰∏¶ÊåÅÁ∫åÁõ£Ê∏¨Ë°ÄÂ£ìËÆäÂåñ„ÄÇ</p>
                    </div>
                `;
            } else {
                statusHTML += '<div class="health-status status-good">‚úÖ Ë°ÄÂ£ìÊ≠£Â∏∏</div>';
            }
            
            // ÂøÉË∑≥ÂàÜÊûê
            if (latest.heartRate > 100) {
                statusHTML += '<div class="health-status status-warning">‚ö° ÂøÉË∑≥ÂÅèÂø´</div>';
                analysisHTML += `
                    <div class="analysis-card">
                        <h3>üíì ÂøÉË∑≥ÂàÜÊûê</h3>
                        <p>ÊÇ®ÁöÑÂøÉË∑≥ÁÇ∫ ${latest.heartRate} Ê¨°/ÂàÜÔºåÁï•È´òÊñºÊ≠£Â∏∏ÁØÑÂúç„ÄÇÂèØËÉΩÂéüÂõ†ÂåÖÊã¨ÔºöÁ∑äÂºµ„ÄÅÂíñÂï°Âõ†„ÄÅÁº∫‰πèÁù°Áú†ÊàñÈÅãÂãï‰∏çË∂≥„ÄÇÂª∫Ë≠∞ÂÖÖË∂≥‰ºëÊÅØ„ÄÅÈÅ©Â∫¶ÈÅãÂãï„ÄÅÊ∏õÂ∞ëÂà∫ÊøÄÊÄßÈ£≤Êñô„ÄÇÂ¶ÇÊåÅÁ∫åÂø´ÈÄüÊàñ‰º¥Èö®‰∏çÈÅ©ÔºåË´ãÂ∞±ÈÜ´Ê™¢Êü•„ÄÇ</p>
                    </div>
                `;
            } else if (latest.heartRate < 60) {
                statusHTML += '<div class="health-status status-warning">‚ö° ÂøÉË∑≥ÂÅèÊÖ¢</div>';
                analysisHTML += `
                    <div class="analysis-card">
                        <h3>üíì ÂøÉË∑≥ÂàÜÊûê</h3>
                        <p>ÊÇ®ÁöÑÂøÉË∑≥ÁÇ∫ ${latest.heartRate} Ê¨°/ÂàÜÔºå‰ΩéÊñºÊ≠£Â∏∏ÁØÑÂúç„ÄÇÈÅãÂãïÂì°ÂèØËÉΩÊúâËºÉ‰ΩéÁöÑÈùúÊÅØÂøÉÁéáÔºå‰ΩÜÂ¶ÇÊûúÊÇ®‰∏çÂ∏∏ÈÅãÂãï‰∏î‰º¥Èö®Áñ≤ÂãûÊàñÊöàÁú©ÔºåÂª∫Ë≠∞Ë´ÆË©¢ÈÜ´Â∏´„ÄÇ</p>
                    </div>
                `;
            } else {
                statusHTML += '<div class="health-status status-good">‚úÖ ÂøÉË∑≥Ê≠£Â∏∏</div>';
            }
            
            // È´îÈáçË∂®Âã¢ÂàÜÊûê
            if (healthRecords.length >= 3) {
                const recent3 = healthRecords.slice(0, 3);
                const weightTrend = recent3[0].weight - recent3[2].weight;
                
                if (Math.abs(weightTrend) > 2) {
                    const direction = weightTrend > 0 ? 'Â¢ûÂä†' : 'Ê∏õÂ∞ë';
                    analysisHTML += `
                        <div class="analysis-card">
                            <h3>‚öñÔ∏è È´îÈáçË∂®Âã¢</h3>
                            <p>ÊúÄËøë‰∏âÊ¨°Ë®òÈåÑÈ°ØÁ§∫È´îÈáç${direction}‰∫Ü ${Math.abs(weightTrend).toFixed(1)} kg„ÄÇ${weightTrend > 0 ? 'È´îÈáçÂø´ÈÄüÂ¢ûÂä†ÂèØËÉΩËàáÈ£≤È£ü„ÄÅÈÅãÂãïÊ∏õÂ∞ëÊàñÊ∞¥ÂàÜÊªØÁïôÊúâÈóú„ÄÇ' : 'È´îÈáçÂø´ÈÄüÊ∏õÂ∞ëÈúÄÊ≥®ÊÑèÁáüÈ§äÂùáË°°ÔºåÈÅøÂÖçÈÅéÂ∫¶ÁØÄÈ£ü„ÄÇ'}Âª∫Ë≠∞Á∂≠ÊåÅÂÅ•Â∫∑ÁöÑÁîüÊ¥ªÊñπÂºèÔºåÂøÖË¶ÅÊôÇË´ÆË©¢ÁáüÈ§äÂ∏´„ÄÇ</p>
                        </div>
                    `;
                }
            }
            
            // Á∂úÂêàÂª∫Ë≠∞
            analysisHTML += `
                <div class="analysis-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <h3>üí° ÂÅ•Â∫∑Âª∫Ë≠∞</h3>
                    <p>ÂÆöÊúüÈáèÊ∏¨Ë°ÄÂ£ì„ÄÅÂøÉË∑≥ÂíåÈ´îÈáçÊòØÁ∂≠Ë≠∑ÂÅ•Â∫∑ÁöÑÈáçË¶ÅÁøíÊÖ£„ÄÇÂª∫Ë≠∞ÊØèÂ§©Âõ∫ÂÆöÊôÇÈñìÈáèÊ∏¨Ôºå‰øùÊåÅË®òÈåÑÁöÑ‰∏ÄËá¥ÊÄß„ÄÇÂêåÊôÇÊ≥®ÊÑèÔºöÂùáË°°È£≤È£ü„ÄÅË¶èÂæãÈÅãÂãï„ÄÅÂÖÖË∂≥Áù°Áú†„ÄÅÈÅ©Â∫¶Ê∏õÂ£ì„ÄÇÂ¶ÇÊúâ‰ªª‰ΩïÁï∞Â∏∏Êàñ‰∏çÈÅ©ÔºåË´ãÂèäÊôÇÂ∞±ÈÜ´„ÄÇ</p>
                </div>
            `;
            
            document.getElementById('healthStatus').innerHTML = statusHTML;
            document.getElementById('analysisContent').innerHTML = analysisHTML;
        }
        
        function toggleReminder(type) {
            reminders[type].enabled = !reminders[type].enabled;
            const toggle = document.getElementById(type + 'Toggle');
            
            if (reminders[type].enabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            // ÂÑ≤Â≠òÊèêÈÜíË®≠ÂÆö
            saveRemindersToLocalStorage();
        }
        
        function updateTimeDisplay() {
            const morningTime = document.getElementById('morningTime').value;
            const eveningTime = document.getElementById('eveningTime').value;
            
            document.getElementById('morningTimeDisplay').textContent = morningTime;
            document.getElementById('eveningTimeDisplay').textContent = eveningTime;
        }
        

        
        async function saveReminders() {
            reminders.morning.time = document.getElementById('morningTime').value;
            reminders.evening.time = document.getElementById('eveningTime').value;
            
            // ÂÑ≤Â≠òÂà∞ localStorage
            saveRemindersToLocalStorage();
            
            // Ë´ãÊ±ÇÈÄöÁü•Ê¨äÈôê
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    setupReminderNotifications();
                    showStatus('‚úÖ ÊèêÈÜíË®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò');
                } else {
                    showStatus('‚ùå ÈúÄË¶ÅÈÄöÁü•Ê¨äÈôêÊâçËÉΩË®≠ÂÆöÊèêÈÜí', true);
                }
            } else {
                showStatus('‚ùå ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥ÈÄöÁü•ÂäüËÉΩ', true);
            }
        }
        
        function setupReminderNotifications() {
            // Ê∏ÖÈô§ËàäÁöÑÊ™¢Êü•
            reminderIntervals.forEach(interval => clearInterval(interval));
            reminderIntervals = [];
            
            // ÊØèÂàÜÈêòÊ™¢Êü•ÊòØÂê¶Ë©≤ÁôºÈÄÅÈÄöÁü•
            const checkInterval = setInterval(() => {
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                if (reminders.morning.enabled && currentTime === reminders.morning.time) {
                    sendNotification('‚è∞ Êó©ÂÆâÔºÅË©≤ÈáèÊ∏¨ÂÅ•Â∫∑Êï∏Êìö‰∫Ü', 'Ë®òÂæóÊ∏¨ÈáèË°ÄÂ£ì„ÄÅÂøÉË∑≥ÂíåÈ´îÈáçÂñîÔºÅ');
                }
                
                if (reminders.evening.enabled && currentTime === reminders.evening.time) {
                    sendNotification('‚è∞ ÊôöÂÆâÔºÅË©≤ÈáèÊ∏¨ÂÅ•Â∫∑Êï∏Êìö‰∫Ü', 'Ë®òÂæóÊ∏¨ÈáèË°ÄÂ£ì„ÄÅÂøÉË∑≥ÂíåÈ´îÈáçÂñîÔºÅ');
                }
            }, 60000); // ÊØèÂàÜÈêòÊ™¢Êü•‰∏ÄÊ¨°
            
            reminderIntervals.push(checkInterval);
        }
        
        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'üè•',
                    badge: 'üè•'
                });
            }
        }
    </script>
</body>
</html>